<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>R-Sight</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>

<script type="text/javascript">
    let screenshot;
    const canvas = document.createElement('canvas'); // create a canvas
    const ctx = canvas.getContext('2d'); // get its context
    let faceId;
    function processImage() {
        // Replace <Subscription Key> with your valid subscription key.
        var subscriptionKey = "5882f9eb1ff3442fa4beaf16c491edfe";

        // NOTE: You must use the same region in your REST call as you used to
        // obtain your subscription keys. For example, if you obtained your
        // subscription keys from westus, replace "westcentralus" in the URL
        // below with "westus".
        //
        // Free trial subscription keys are generated in the "westus" region.
        // If you use a free trial subscription key, you shouldn't need to change 
        // this region.
        var uriBase =
            "https://westcentralus.api.cognitive.microsoft.com/face/v1.0/detect?returnFaceId=true&returnFaceLandmarks=false";
        

        // Perform the REST API call.
        let data = canvas.toDataURL('image/jpeg');

        fetch(uriBase, {
            method: 'POST',
            body: makeBlob(data),
            headers: {
                'Content-Type': 'application/octet-stream',
                'Ocp-Apim-Subscription-Key': '5882f9eb1ff3442fa4beaf16c491edfe'
            }
        })  
            .then(res => res.json())
            .then(response => {
                faceId = response[0].faceId;
                return verify(faceId);
            })
            .catch(err => {
                setTimeout(function(){
                document.querySelector('.modal').classList.remove('active');
                window.alert("You are not Andy...")    
              }, 2000);
            });

        }

        // $.ajax({
        //     url: uriBase,
        //     // Request headers.
        //     beforeSend: function(xhrObj){
        //         xhrObj.setRequestHeader("Content-Type","application/octet-stream");
        //         xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", subscriptionKey);
        //     },

        //     type: "POST",
        //     // Request body.
        //     data: screenshot,
        // })

        // .done(function(data) {
        //     // Show formatted JSON on webpage.
        //     $("#responseTextArea").val(JSON.stringify(data, null, 2));
        // })

        // .fail(function(jqXHR, textStatus, errorThrown) {
        //     // Display error message.
        //     var errorString = (errorThrown === "") ?
        //         "Error. " : errorThrown + " (" + jqXHR.status + "): ";
        //     errorString += (jqXHR.responseText === "") ?
        //         "" : (jQuery.parseJSON(jqXHR.responseText).message) ?
        //             jQuery.parseJSON(jqXHR.responseText).message :
        //                 jQuery.parseJSON(jqXHR.responseText).error.message;
        //     alert(errorString);
        // });
    function verify(id) {
        var subscriptionKey = "5882f9eb1ff3442fa4beaf16c491edfe";
        var uriBase =
            "https://westcentralus.api.cognitive.microsoft.com/face/v1.0/identify";

        fetch(uriBase, {
            method: 'POST',
            body: JSON.stringify({
                personGroupId: "users",
                faceIds: [id], 
            }),
            headers: {
                'Content-Type': 'application/json',
                'Ocp-Apim-Subscription-Key': '5882f9eb1ff3442fa4beaf16c491edfe'
        }
    })  
        .then(res => res.json())
        .then(response => {
            if (response[0].candidates[0].confidence) {
            setTimeout(function(){
                window.alert("♥♥♥     Welcome back, Andy!!!!!!     ♥♥♥\nYou are now entering Andy's secret page :)  ")
                window.location = "http://localhost:3000/user"; 
            }, 2000);
              
            } 
        })
        .catch(err => {
            setTimeout(function(){
                document.querySelector('.modal').classList.remove('active');
                window.alert("You are not Andy...")    
            }, 2000);
        });
    }

</script>


<div class="home-grid-container">
    <div id="homeapp">
        <h1>R-Sight</h1>
    </div>
    <div id="content">
    <div id="container">
        <video autoplay="true" id="videoElement">
        <script>
        const video = document.querySelector("#videoElement");
            
            if (navigator.mediaDevices.getUserMedia) {       
                navigator.mediaDevices.getUserMedia({video: true})
                .then(function(stream) {
                    video.srcObject = stream;
                    return video.play();
                })
                .then(()=>{ // enable the button
                    const btn = document.querySelector('#button');
                    btn.disabled = false;
                    btn.onclick = e => {
                        document.querySelector('.modal').classList.add('active');
                        takeASnap()
                        .then(download)
                    };
                })
                .catch(function(error) {
                    console.log("Something went wrong!");
                });
            }

            function takeASnap() {
                
                canvas.width = video.videoWidth; // set its size to the one of the video
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0,0); // the video
            screenshot = canvas.toDataURL('image/jpeg')
                let dataUri = canvas.toDataURL('image/jpeg');
                let data = dataUri.split(',')[1];
                let mimeType = dataUri.split(';')[0].slice(5)

                let bytes = window.atob(data);
                let buf = new ArrayBuffer(bytes.length);
                let byteArr = new Uint8Array(buf);

                for (let i = 0; i < bytes.length; i++) {
                    byteArr[i] = bytes.charCodeAt(i);
                }
                screenshot = byteArr;
                return new Promise((res, rej)=> {
                    canvas.toBlob(res, 'image/jpeg'); // request a Blob from the canvas
                });
            }

            function makeBlob(dataURL) {

            const BASE64_MARKER = ';base64,';
            const parts = dataURL.split(BASE64_MARKER);
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;

            const uInt8Array = new Uint8Array(rawLength);

                for (var i = 0; i < rawLength; ++i) {
                    uInt8Array[i] = raw.charCodeAt(i);
                }
                return new Blob([uInt8Array], { type: contentType });
            }

            function download(blob){ 
                // screenshot = canvas.toDataURL(blob);
                // screenshot = URL.createObjectURL(blob);
                // screenshot = screenshot.slice(5);
                processImage();
                // a.download = 'screenshot.jpg';
            }
        </script>
        </video>
    </div>
</div>
    <div id="buttons"> 
        <button id="button">Analyze face</button>
        <button onclick="location.href = 'http://localhost:3000/login;'">Manual Sign-in</button>
    </div>
    <div class="modal"><img src="loading.gif"/></div>
</div>
</body>
</html>
